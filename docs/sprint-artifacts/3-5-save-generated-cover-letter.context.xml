<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>5</storyId>
    <title>Save Generated Cover Letter</title>
    <status>drafted</status>
    <generatedAt>2025-12-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-5-save-generated-cover-letter.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>logged-in student user</asA>
    <iWant>to save a generated cover letter that I am satisfied with</iWant>
    <soThat>I can access it later</soThat>
    <tasks>
      <task>
        <description>Frontend: Implement save functionality for the cover letter.</description>
        <acceptance_criteria_ref>1, 2, 3</acceptance_criteria_ref>
        <subtask>Integrate POST /api/v1/cover-letters request when "Save" button is clicked.</subtask>
        <subtask>Manage loading, error, and success states using React Query.</subtask>
        <subtask>Update the UI of the "Save" button to "Saved ✓" and disable it on successful save.</subtask>
        <subtask>Display a Shadcn/UI Toast notification to confirm the save action.</subtask>
      </task>
      <task>
        <description>Backend: Implement API endpoint for saving cover letters.</description>
        <acceptance_criteria_ref>3</acceptance_criteria_ref>
        <subtask>Create POST /api/v1/cover-letters endpoint.</subtask>
        <subtask>Implement logic to store the cover letter content in Supabase, linked to the user and job application.</subtask>
        <subtask>Ensure proper authentication and authorization (RLS) for the save operation.</subtask>
      </task>
      <task>
        <description>Testing: Add Playwright E2E tests.</description>
        <acceptance_criteria_ref>1, 2, 3</acceptance_criteria_ref>
        <subtask>Mock the API response for saving a cover letter.</subtask>
        <subtask>Verify that clicking "Save" changes the button state and displays a toast notification.</subtask>
        <subtask>Verify that a successful save operation is recorded in the mocked backend.</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="1">Given a cover letter is displayed, when I click the "Save" button, then the button's state changes to "Saved ✓" and becomes disabled.</criterion>
    <criterion id="2">And a toast notification confirms the save action.</criterion>
    <criterion id="3">And the cover letter text is successfully saved to the Supabase database, associated with my user ID and the job application.</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>CVAI Turbo - Product Requirements Document</title>
        <section>Functional Requirements</section>
        <snippet>FR-3.6 [MVP] The system shall provide an option for the user to save the generated cover letter.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>API Contracts</section>
        <snippet>API Type: RESTful API exposed by FastAPI. ... Versioning: Versioned at /api/v1/. ... Data Formats: JSON request/response format for all communication.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Data Architecture</section>
        <snippet>Primary Database: Supabase (PostgreSQL). Data Modeling: Relational database with tables for users, CVs, job applications, and cover letters. Data Isolation: Row Level Security (RLS) in Supabase will enforce user-specific data access.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>ibe160 UX Design Specification</title>
        <section>Cover Letter Generation Flow</section>
        <snippet>Saving the Cover Letter: User clicks the "Save" button. System Response: The button's text immediately changes to "Saved ✓" and it becomes disabled. Simultaneously, a temporary notification ("toast") appears at the top of the screen stating, "Cover letter saved to your collection."</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>ibe160 UX Design Specification</title>
        <section>Component Library</section>
        <snippet>Standard Components (from Shadcn/UI): ... Toast: For displaying non-intrusive notifications (e.g., "Cover letter saved").</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>CVAI Turbo - Epics &amp; Stories</title>
        <section>Story 3.5: Save Generated Cover Letter</section>
        <snippet>As a logged-in student user, I want to save a generated cover letter that I am satisfied with, so that I can access it later. Covers: FR-3.6.</snippet>
      </doc>
    </docs>
    <code>
      <path>backend/app/api/v1/cover_letters.py</path>
      <kind>API Endpoint Definition</kind>
      <symbol>POST /cover-letters</symbol>
      <lines>N/A (New File)</lines>
      <reason>This story requires creating a new API endpoint to handle saving cover letters. The file does not exist yet.</reason>
    </code>
    <dependencies>
      <node>
        <package name="@faker-js/faker" version="^8.0.0" />
        <package name="@playwright/test" version="^1.40.0" />
        <package name="@hookform/resolvers" version="^5.2.2" />
        <package name="@radix-ui/react-alert-dialog" version="^1.1.15" />
        <package name="@radix-ui/react-label" version="^2.1.8" />
        <package name="@radix-ui/react-slot" version="^1.2.4" />
        <package name="@radix-ui/react-tabs" version="^1.1.13" />
        <package name="@radix-ui/react-toast" version="^1.2.15" />
        <package name="@supabase/supabase-js" version="^2.87.1" />
        <package name="@tanstack/react-query" version="^5.90.12" />
        <package name="class-variance-authority" version="^0.7.1" />
        <package name="clsx" version="^2.1.1" />
        <package name="lucide-react" version="^0.555.0" />
        <package name="next" version="^16.0.10" />
        <package name="react" version="^19.2.1" />
        <package name="react-dom" version="^19.2.1" />
        <package name="react-hook-form" version="^7.68.0" />
        <package name="tailwind-merge" version="^3.4.0" />
        <package name="tailwindcss-animate" version="^1.0.7" />
      </node>
      <python>
        <package name="fastapi" version="0.123.8" />
        <package name="postgrest" version="2.25.0" />
        <package name="supabase" version="2.25.0" />
        <package name="uvicorn" version="0.38.0" />
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>API Communication</type>
      <description>The frontend will use React Query for API calls and state management of the save operation.</description>
    </constraint>
    <constraint>
      <type>Database</type>
      <description>The cover letter text must be stored in the Supabase database, associated with the user's ID and the corresponding job application.</description>
    </constraint>
    <constraint>
      <type>Security</type>
      <description>Proper authentication and authorization (RLS) must be enforced for the save operation.</description>
    </constraint>
    <constraint>
      <type>UI Feedback</type>
      <description>A Shadcn/UI Toast component will be used for notifications.</description>
    </constraint>
    <constraint>
      <type>Testing Standard</type>
      <description>E2E tests should use `data-testid` for robust element selection and mock API responses with Playwright's `page.route()`.</description>
    </constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>Save Cover Letter API</name>
      <kind>REST endpoint</kind>
      <signature>POST /api/v1/cover-letters (Body: { cover_letter_content: string, job_application_id: string })</signature>
      <path>backend/app/api/v1/cover_letters.py</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Jest for unit/component tests and Playwright for end-to-end (E2E) tests. E2E tests should use `data-testid` for robust element selection and mock API responses with Playwright's `page.route()`.</standards>
    <locations>
      <location>frontend/__tests__/</location>
      <location>frontend/playwright/</location>
      <location>tests/e2e/</location>
    </locations>
    <ideas>
      <idea ac_id="1, 2">
        <description>Verify that clicking the "Save" button changes its UI to "Saved ✓" and disables it, and that a toast notification appears with a success message.</description>
        <tool>Playwright E2E</tool>
      </idea>
      <idea ac_id="3">
        <description>Verify that clicking the "Save" button triggers a POST request to `/api/v1/cover-letters` with the correct payload (cover letter content and job application ID).</description>
        <tool>Playwright E2E</tool>
      </idea>
      <idea ac_id="3">
        <description>Mock the API response for saving and verify that the frontend handles success and error states correctly.</description>
        <tool>Playwright E2E</tool>
      </idea>
    </ideas>
  </tests>
</story-context>